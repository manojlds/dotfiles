#!/usr/bin/env bash
# sysmon - system monitor wrapper
# Auto-selects compact or full view based on terminal size

COLS=$(tput cols 2>/dev/null || echo 80)
ROWS=$(tput lines 2>/dev/null || echo 24)

compact_view() {
  echo -e '\033[1;36m── sysmon ──\033[0m'
  echo ''

  # CPU load
  read -r one five fifteen _ < /proc/loadavg
  cores=$(nproc)
  echo -e "\033[1mCPU\033[0m  $one $five $fifteen  (${cores}c)"

  # Temps (prefer lm-sensors, fallback to thermal_zone)
  if command -v sensors &>/dev/null; then
    cpu_temp=$(sensors k10temp-pci-00c3 2>/dev/null | awk '/Tctl:/{gsub(/[+°C]/,"",$2); printf "%.0f",$2}')
    gpu_temp=$(sensors amdgpu-pci-0300 2>/dev/null | awk '/edge:/{gsub(/[+°C]/,"",$2); printf "%.0f",$2}')
    [ -z "$cpu_temp" ] && cpu_temp=$(sensors 2>/dev/null | awk '/Tctl:|Package id 0:/{gsub(/[+°C]/,"",$2); printf "%.0f",$2; exit}')
    [ -n "$cpu_temp" ] && echo -e "\033[1mCPU\033[0m  ${cpu_temp}°C$([ -n "$gpu_temp" ] && echo "  \033[1mGPU\033[0m ${gpu_temp}°C")"
  else
    temp_file=$(find /sys/class/hwmon/*/temp1_input 2>/dev/null | while read f; do
      name=$(cat "$(dirname "$f")/name" 2>/dev/null)
      [ "$name" = "k10temp" ] || [ "$name" = "coretemp" ] && echo "$f" && break
    done)
    if [ -n "$temp_file" ]; then
      raw=$(cat "$temp_file")
      [ "$raw" -gt 1000 ] 2>/dev/null && echo -e "\033[1mTMP\033[0m  $((raw / 1000))°C"
    fi
  fi

  # Memory
  total=$(awk '/MemTotal/{print $2}' /proc/meminfo)
  avail=$(awk '/MemAvailable/{print $2}' /proc/meminfo)
  used=$(( (total - avail) / 1024 ))
  total_mb=$((total / 1024))
  pct=$(( (total - avail) * 100 / total ))
  echo -e "\033[1mMEM\033[0m  ${used}M/${total_mb}M ${pct}%"

  # Disk
  df -h / | awk 'NR==2{printf "\033[1mDSK\033[0m  %s/%s %s\n",$3,$2,$5}'

  # Network
  echo ''
  awk '
    function human(b) {
      if (b >= 1073741824) return sprintf("%.1fG", b/1073741824)
      if (b >= 1048576)    return sprintf("%.1fM", b/1048576)
      if (b >= 1024)       return sprintf("%.1fK", b/1024)
      return sprintf("%.0fB", b)
    }
    NR>2 && $1 !~ /lo:/{
      gsub(":"," ",$1);
      printf "\033[1m%-6s\033[0m ▼%s ▲%s\n",$1,human($2),human($10)
    }
  ' /proc/net/dev

  # Top 3 processes by CPU
  echo ''
  echo -e '\033[1;33mTOP CPU\033[0m'
  ps -eo pcpu,pmem,comm --sort=-pcpu --no-headers | head -3 | awk '{printf "  %5s%% %5s%% %s\n",$1,$2,$3}'
}

# Called by watch with --compact flag
if [ "${1:-}" = "--compact" ]; then
  compact_view
  exit 0
fi

# Mobile / very small terminal: custom compact view
if [ "$COLS" -lt 80 ] || [ "$ROWS" -lt 20 ]; then
  watch -n 2 -t -c "$(readlink -f "$0")" --compact
# Medium terminal: btop with compact preset (cpu + mem only)
elif [ "$COLS" -lt 120 ] || [ "$ROWS" -lt 30 ]; then
  exec btop -p 1
# Full desktop: btop with all panels
else
  exec btop
fi
